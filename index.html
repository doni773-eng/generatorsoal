<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>GENERATOR SOAL SMAN 12 KAUR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
 
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        startup: {
            pageReady: () => {
                return MathJax.startup.defaultPageReady();
            }
        }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --neon: #00f2ff;
            --neon2: #7000ff;
            --danger: #ff0055;
            --success: #00ff88;
            --bg-main: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            --bg-container: rgba(15, 23, 42, 0.7);
            --bg-section: rgba(2, 6, 23, 0.4);
            --text-main: #f8fafc;
            --border: rgba(0, 242, 255, 0.3);
            --input-bg: rgba(0, 0, 0, 0.3);
        }
      
      [id^="math-panel-"] {
    transition: all 0.3s ease;
}

        [data-theme="light"] {
            --bg-main: radial-gradient(circle at center, #f1f5f9 0%, #cbd5e1 100%);
            --bg-container: rgba(255, 255, 255, 0.8);
            --bg-section: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --border: rgba(112, 0, 255, 0.3);
            --input-bg: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background: var(--bg-main);
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            padding: 40px 0;
            overflow-x: hidden;
        }

        .theme-switch {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: var(--neon2); color: white; border: none;
            padding: 10px 15px; border-radius: 50px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 8px;
        }

        .container {
            width: 1100px; max-width: 95%; background: var(--bg-container);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 30px;
            padding: 40px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
            animation: fadeInDown 0.8s;
        }

        h2 {
            text-align: center; font-size: 2.5rem; letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--neon), var(--neon2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        .section {
            margin-top: 30px; padding: 25px; border-radius: 20px;
            background: var(--bg-section); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }

        .section h3 { margin: 0 0 20px; font-size: 18px; text-transform: uppercase; color: var(--neon2); }

        input[type="text"], input[type="file"], textarea {
            width: 100%; margin-top: 10px; padding: 14px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--input-bg);
            color: var(--text-main); outline: none;
        }

        button {
            margin-top: 12px; padding: 12px 24px; border-radius: 12px;
            border: none; font-weight: 700; text-transform: uppercase;
            font-size: 11px; cursor: pointer;
            background: linear-gradient(135deg, var(--neon), var(--neon2)); color: white;
        }

        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(112, 0, 255, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .peserta-card {
            background: rgba(112, 0, 255, 0.05); padding: 15px;
            border-radius: 15px; border: 1px solid var(--border);
        }

        .cb-label {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--input-bg); padding: 6px 14px;
            border-radius: 8px; cursor: pointer; font-size: 11px;
        }

        .math-tool-btn {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--neon);
            padding: 5px 10px;
            font-size: 14px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
            font-family: "Times New Roman", serif;
        }

        .math-tool-btn:hover { background: var(--neon); color: black; }

        .page {
    width: 794px; background: #fff; color: #333;
    margin: 20px auto; border-radius: 5px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

        .soal-print-item {
            border-bottom: 1px dotted #ccc;
            padding: 10px 0;
            margin-bottom: 5px;
        }
        
        .soal-print-item p {
            margin: 2px 0;
            line-height: 1.4;
        }

        .soal-print-item:last-child { border-bottom: none; }
        
        .excel-btn { background: #10b981; }
        .reset-btn { background: var(--danger); }
        .pdf-btn { background: #e11d48; }

        .preview-wrapper {
            margin-top: 10px;
            border: 1px dashed var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .preview-header {
            background: rgba(0, 242, 255, 0.1);
            padding: 8px 15px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            color: var(--neon);
        }

        .preview-header:hover { background: rgba(0, 242, 255, 0.2); }

        .live-math-preview {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            min-height: 40px;
            color: var(--neon);
            font-size: 16px;
            display: none;
        }

        [data-theme="light"] .live-math-preview {
            background: rgba(0, 0, 0, 0.05);
            color: #000;
        }

        #loadingOverlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 9999; 
            flex-direction: column; align-items: center; justify-content: center;
        }

        /* FITUR FULLSCREEN PRINT PREVIEW */
        #fullScreenModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2d3436; z-index: 10000; overflow-y: auto; padding: 20px;
        }
        .modal-controls {
            position: sticky; top: 0; background: #1e272e; padding: 15px;
            display: flex; gap: 10px; justify-content: center; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 20px;
        }

        @media print {
    body { background: white !important; padding: 0 !important; }
    .container, .theme-switch, .modal-controls, #loadingOverlay { display: none !important; }
    #fullScreenModal { position: static; display: block !important; padding: 0 !important; background: white !important; overflow: visible !important; }
    .page { box-shadow: none !important; margin: 0 !important; border-bottom: none !important; page-break-after: always; }
}

        @media (max-width: 768px) {
            .container { padding: 20px; }
            .page { width: 100% !important; }
        }
      .table-builder {
    background: rgba(0,0,0,0.25);
    border: 1px dashed var(--border);
    padding: 15px;
    border-radius: 12px;
    margin-top: 10px;
}

/* ===== PANEL PEMBUATAN TABEL ===== */
.table-builder {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0,0,0,0.35);
    border: 1px dashed #00f2ff;
    border-radius: 12px;
}

/* GRID INPUT SEL TABEL */
.table-builder-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 12px;
}

/* INPUT SEL TABEL */
.table-builder-grid input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0,242,255,0.4);
    background: rgba(0,0,0,0.4);
    color: #fff;
    text-align: center;
    font-size: 13px;
}

/* HEADER PANEL */
.table-builder h4 {
    font-size: 12px;
    letter-spacing: 1px;
    margin-bottom: 10px;
    color: #00f2ff;
}
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="color:var(--neon); font-size: 20px; font-weight: bold; margin-bottom: 10px;">PROSES IMPORT DATABASE...</div>
    <div id="progressText" style="color:white; font-size: 24px; font-weight: bold;">0%</div>
    <div id="progressCount" style="color:rgba(255,255,255,0.6); font-size: 14px; margin-top: 5px;">0 / 0 Data</div>
</div>

<div id="fullScreenModal">
    <div class="modal-controls">
        <button onclick="printDirectly()" style="background: var(--success); color: black;">CETAK SEKARANG (DIRECT PRINT)</button>
        <button onclick="closeFullscreen()" style="background: var(--danger);">KEMBALI KE EDITOR</button>
    </div>
    <div id="printArea"></div>
</div>

<button class="theme-switch" onclick="toggleTheme()" id="themeBtn">
    <span id="themeIcon">üåô</span> <span id="themeText">Mode Gelap</span>
</button>

<div class="container">
    <h2><span style="font-weight: 200;">GENERATOR</span> SOAL</h2>
    <p style="text-align: center; margin-top: -30px; font-size: 12px;">Created By: Doni Stiawan</p>

    <div class="section">
        <h3>01. Database & Konfigurasi</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px;">
            <input type="file" id="fileExcel" accept=".xlsx,.xls">
            <button onclick="importExcel()" id="importBtn" class="excel-btn">Impor Database (XLSX)</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Matriks Kelas Aktif:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="customKelasInput" value="X MIPA, X IPS, XI MIPA, XI IPS, XII MIPA, XII IPS">
                <button onclick="updateMasterKelas()" style="background: var(--neon2);">Sinkron</button>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 242, 255, 0.1); border-radius: 12px; border: 1px dashed var(--neon);">
            <label style="font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--neon);">MASUKAN MATA PELAJARAN</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="globalMapel" placeholder="Sesuaikan Dengan Mata Pelajaran Masing-Masing">
                <button onclick="updateSemuaMapel()" style="background: var(--success); color: #000; min-width: 150px;">TEKAN UNTUK MENAMBAHKAN MAPEL</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px;">
            <input type="text" id="nama" placeholder="Nama Lengkap">
            <input type="text" id="kelas" placeholder="Kelas">
            <input type="text" id="mapel" placeholder="Mata Pelajaran">
            <input type="text" id="ruangan" placeholder="Ruangan">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="tambahManual()" style="flex: 2;">Tambah Peserta</button>
            <button onclick="resetData()" class="reset-btn" style="flex: 1;">Hapus Semua Data</button>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <b style="font-size:12px; letter-spacing:1px;">HASIL INPUT DATA PESERTA</b>
    <button onclick="togglePeserta()" id="btnTogglePeserta"
        style="background:#334155; font-size:10px; padding:6px 14px;">
        Sembunyikan ‚ñ¥
    </button>
</div>
        </div>
        <div id="daftarPeserta" style="margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px;"></div>
    </div>

    <div class="section">
        <h3>02. Pertanyaan</h3>
        <p style="font-size: 11px; opacity: 0.7; margin-top: -10px;">Pilih target kelas spesifik. Klik tombol simbol untuk memasukkan rumus matematika.</p>
        <div id="containerSoal"></div>
        <button onclick="tambahInputSoal()" style="width: 100%; background: #0ea5e9;">+ TAMBAHKAN SOAL BARU</button>
    </div>

    <div class="section" style="display: flex; gap: 10px; background: transparent; border: none; flex-wrap: wrap;">
        <button onclick="openFullscreenPreview()" style="flex: 1; background: #00ff88; color: black; font-size: 16px;">PRATINJAU FULL & PRINT</button>
        <button onclick="preview()" style="flex: 1; background: #334155; font-size: 16px;">Pratinjau List</button>
        <button onclick="exportWord()" style="flex: 1; font-size: 16px; background: var(--neon2);">Ekspor Word</button>
        <button onclick="exportPDF()" class="pdf-btn" style="flex: 1; font-size: 16px;">Ekspor PDF</button>
    </div>

    <div id="previewArea"></div>
</div>

<script>
    let dataPeserta = [];
    let listSoal = [];
    let OPSI_KELAS = ["X MIPA", "X IPS", "XI MIPA", "XI IPS", "XII MIPA", "XII IPS"];
    let pesertaVisible = false;

    const MATH_SYMBOLS = [
        { label: 'Pecahan', code: '\\frac{a}{b}' },
        { label: 'Akar', code: '\\sqrt{x}' },
        { label: 'Pangkat', code: 'x^{2}' },
        { label: 'Subskrip', code: 'x_{1}' },
        { label: 'Integral', code: '\\int_{a}^{b} f(x) dx' },
        { label: 'Limit', code: '\\lim_{x \\to \\infty}' },
        { label: 'Sigma', code: '\\sum_{i=1}^{n}' },
        { label: 'Alpha', code: '\\alpha' },
        { label: 'Beta', code: '\\beta' },
        { label: 'Pi', code: '\\pi' },
        { label: 'Vektor', code: '\\overrightarrow{}' },
        { label: 'Log', code: '\\log_{a}' },
        { label: 'Vektor Kolom', code: '\\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix}' },
    ];

    /* FITUR BARU: FULLSCREEN & PRINT */
    function openFullscreenPreview() {
        if(!dataPeserta.length) return alert("Belum ada data peserta!");
        preview(); // Jalankan preview internal dulu
        
        const areaPreview = document.getElementById("previewArea").innerHTML;
        if(!areaPreview) return;

        document.getElementById("printArea").innerHTML = areaPreview;
        document.getElementById("fullScreenModal").style.display = "block";
        document.body.style.overflow = "hidden";

        if (window.MathJax) {
            MathJax.typesetPromise([document.getElementById("printArea")]);
        }
    }
  
  function toggleMathPanel(id) {
    const panel = document.getElementById(`math-panel-${id}`);
    const btn = document.getElementById(`math-toggle-${id}`);

    if (!panel || !btn) return;

    if (panel.style.display === "none") {
        panel.style.display = "flex";
        btn.innerHTML = "Sembunyikan Simbol ‚ñ¥";
    } else {
        panel.style.display = "none";
        btn.innerHTML = "Tampilkan Simbol ‚ñæ";
    }
}

  function openTableBuilder(id) {
    const panel = document.getElementById(`table-builder-${id}`);
    panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function generateTableInputs(id) {
    const rows = parseInt(document.getElementById(`tb-rows-${id}`).value);
    const cols = parseInt(document.getElementById(`tb-cols-${id}`).value);
    const grid = document.getElementById(`tb-grid-${id}`);

    if (!rows || !cols || rows < 1 || cols < 1) {
        return alert("Jumlah baris dan kolom tidak valid!");
    }

    grid.innerHTML = "";
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    for (let i = 0; i < rows * cols; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `Sel ${i + 1}`;
        grid.appendChild(input);
    }
}

function insertCustomTable(id) {
    const rows = parseInt(document.getElementById(`tb-rows-${id}`).value);
    const cols = parseInt(document.getElementById(`tb-cols-${id}`).value);
    const grid = document.getElementById(`tb-grid-${id}`);
    const textarea = document.getElementById(`text-${id}`);

    if (!textarea || !rows || !cols) return;

    let tableHTML = `<table border="1" style="border-collapse:collapse; width:100%; margin:10px 0;">`;
    const inputs = grid.querySelectorAll("input");
    let index = 0;

    for (let r = 0; r < rows; r++) {
        tableHTML += "<tr>";
        for (let c = 0; c < cols; c++) {
            const val = inputs[index]?.value || "";
            tableHTML += `<td style="padding:6px; text-align:center;">${val}</td>`;
            index++;
        }
        tableHTML += "</tr>";
    }

    tableHTML += "</table>\n";

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    textarea.value =
        textarea.value.substring(0, start) +
        tableHTML +
        textarea.value.substring(end);

    textarea.focus();
    updateLivePreview(id);
}
  
  
  
function togglePeserta() {
    const container = document.getElementById("daftarPeserta");
    const btn = document.getElementById("btnTogglePeserta");

    if (pesertaVisible) {
        container.style.display = "none";
        btn.innerHTML = "Tampilkan ‚ñæ";
    } else {
        container.style.display = "grid";
        btn.innerHTML = "Sembunyikan ‚ñ¥";
    }

    pesertaVisible = !pesertaVisible;
}
  // Fungsi untuk mendapatkan dimensi asli gambar (Width & Height)
function getImageDimensions(base64) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            resolve({ w: img.width, h: img.height });
        };
        img.src = base64;
    });
}

  function insertTable(id, rows = 2, cols = 2) {
    const textarea = document.getElementById(`text-${id}`);
    if (!textarea) return;

    let tableHTML = `<table border="1" style="border-collapse:collapse; width:100%; margin:10px 0;">`;

    for (let r = 0; r < rows; r++) {
        tableHTML += "<tr>";
        for (let c = 0; c < cols; c++) {
            tableHTML += `<td style="padding:6px; text-align:center;">&nbsp;</td>`;
        }
        tableHTML += "</tr>";
    }

    tableHTML += "</table>\n";

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    textarea.value =
        textarea.value.substring(0, start) +
        tableHTML +
        textarea.value.substring(end);

    textarea.focus();
    updateLivePreview(id);
}
  
    function closeFullscreen() {
        document.getElementById("fullScreenModal").style.display = "none";
        document.body.style.overflow = "auto";
    }

    function printDirectly() {
        window.print();
    }
    /* END FITUR BARU */

    function toggleTheme() {
        const html = document.documentElement;
        const btnText = document.getElementById("themeText");
        const btnIcon = document.getElementById("themeIcon");
        if (html.getAttribute("data-theme") === "dark") {
            html.setAttribute("data-theme", "light");
            btnText.innerText = "Mode Terang"; btnIcon.innerText = "‚òÄÔ∏è";
        } else {
            html.setAttribute("data-theme", "dark");
            btnText.innerText = "Mode Gelap"; btnIcon.innerText = "üåô";
        }
    }

    function toggleAccordion(id) {
        const previewDiv = document.getElementById(`live-preview-${id}`);
        const statusText = document.getElementById(`status-${id}`);
        if (window.getComputedStyle(previewDiv).display === "none") {
            previewDiv.style.display = "block";
            statusText.innerText = "Tutup ‚ñ¥";
        } else {
            previewDiv.style.display = "none";
            statusText.innerText = "Buka ‚ñæ";
        }
    }

    function updateLivePreview(id) {
        const textarea = document.getElementById(`text-${id}`);
        const previewDiv = document.getElementById(`live-preview-${id}`);
        if (!textarea || !previewDiv) return;
        let content = textarea.value.replace(/\n/g, '<br>');
        previewDiv.innerHTML = content || '<span style="opacity:0.5; font-size:12px;">Pratinjau matematika otomatis...</span>';
        if (window.MathJax) {
            MathJax.typesetPromise([previewDiv]);
        }
    }

    function insertMath(id, code) {
        const textarea = document.getElementById(`text-${id}`);
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const replacement = `$${code}$`; 
        textarea.value = text.substring(0, start) + replacement + text.substring(end);
        const soal = listSoal.find(s => s.id == id);
        if(soal) soal.teks = textarea.value;
        textarea.focus();
        const cursorOffset = code.indexOf('{') !== -1 ? code.indexOf('{') + 2 : code.length + 1;
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
        updateLivePreview(id);
    }

    function updateSemuaMapel() {
        const mapelBaru = document.getElementById("globalMapel").value.trim();
        if(!mapelBaru) return alert("Masukkan nama mata pelajaran terlebih dahulu!");
        if(dataPeserta.length === 0) return alert("Belum ada data peserta yang bisa diubah!");
        if(confirm(`Ubah semua mata pelajaran menjadi "${mapelBaru}"?`)) {
            dataPeserta.forEach(p => { p.mapel = mapelBaru; });
            renderPeserta();
            alert("Berhasil memperbarui semua mata pelajaran.");
            document.getElementById("globalMapel").value = "";
        }
    }

    function updateMasterKelas() {
        const input = document.getElementById("customKelasInput").value;
        if(!input.trim()) return;
        OPSI_KELAS = input.split(",").map(k => k.trim().toUpperCase()).filter(k => k !== "");
        refreshSemuaCheckboxSoal();
        alert("Matriks Kelas Berhasil Diperbarui");
    }

    function refreshSemuaCheckboxSoal() {
        listSoal.forEach(soal => {
            const container = document.getElementById(`cb-group-${soal.id}`);
            if(container) {
                const prevChecked = soal.targetKelas;
                container.innerHTML = OPSI_KELAS.map(k => `
                    <label class="cb-label">
                        <input type="checkbox" value="${k}" onchange="updateSoalKelas('${soal.id}')" ${prevChecked.includes(k) ? 'checked' : ''}> ${k}
                    </label>
                `).join("");
            }
        });
    }

    function toggleSelectAll(id, checked) {
        const container = document.getElementById(`cb-group-${id}`);
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = checked;
        });
        updateSoalKelas(id);
    }

    function tambahInputSoal() {
        const id = Date.now() + Math.random();
        const div = document.createElement("div");
        div.className = "soal-item animate__animated animate__slideInLeft";
        div.style.cssText = "margin-bottom:20px; padding:20px; border-radius:15px; background:rgba(128,128,128,0.1);";
        div.id = `item-${id}`;
        
        let checkboxesHtml = OPSI_KELAS.map(k => `
            <label class="cb-label">
                <input type="checkbox" value="${k}" onchange="updateSoalKelas('${id}')"> ${k}
            </label>
        `).join("");

        let mathButtons = MATH_SYMBOLS.map(sym => {
            const escapedCode = sym.code.replace(/\\/g, '\\\\');
            return `<button type="button" class="math-tool-btn" onclick="insertMath('${id}', '${escapedCode}')">${sym.label}</button>`;
        }).join("");

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <span style="font-size:10px; font-weight:bold; letter-spacing:2px;">KONFIGURASI SOAL & MATEMATIKA</span>
                    <label style="font-size:10px; cursor:pointer; color:var(--success); display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:4px;">
                        <input type="checkbox" onchange="toggleSelectAll('${id}', this.checked)"> CEKLIS SEMUA KELAS
                    </label>
                </div>
                <button onclick="hapusInputSoal('${id}')" style="background:var(--danger); padding:5px 10px; margin:0;">Hapus</button>
            </div>
            <div class="checkbox-group" id="cb-group-${id}" style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:5px;">
                ${checkboxesHtml}
            </div>
            <button id="math-toggle-${id}"
    onclick="toggleMathPanel('${id}')"
    style="background:#334155; font-size:10px; padding:6px 14px; margin-bottom:8px;">
    Tampilkan Simbol ‚ñæ
</button>

<div id="math-panel-${id}"
     style="margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.2);
            border-radius:10px; display:none; flex-wrap:wrap; gap:2px;">

    ${mathButtons}

<button type="button" class="math-tool-btn"
    onclick="toggleTableInput('${id}')">
    TABEL INPUT
</button>

    

    <button style="margin-top:10px; background:var(--success); color:black;"
        onclick="insertCustomTable('${id}')">
        Sisipkan ke Soal
    </button>
</div>
</div>
         
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <textarea id="text-${id}" style="flex:1; min-width: 250px; min-height:100px;" 
                        placeholder="Silahkan Masukan Soal" 
                        oninput="updateSoalTeks('${id}', this.value); updateLivePreview('${id}')"></textarea>
                        <!-- PANEL PEMBUATAN TABEL (BAGIAN BAWAH) -->
<div id="table-builder-${id}" class="table-builder" style="display:none;">
    <h4 style="margin:0 0 10px; color:#0ff;">PEMBUATAN TABEL</h4>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <input type="number" id="tb-rows-${id}" placeholder="Baris" min="1" style="width:80px;">
        <input type="number" id="tb-cols-${id}" placeholder="Kolom" min="1" style="width:80px;">
        <button onclick="generateTableInputs('${id}')" class="math-tool-btn">
            BUAT GRID
        </button>
<button class="btn-reset-table" onclick="resetTableInputs(${id})">
    RESET TABEL
</button>
    </div>

    <div id="tb-grid-${id}" class="table-builder-grid"></div>

    <button onclick="insertCustomTable('${id}')"
        style="margin-top:10px;"
        class="math-tool-btn success">
        SISIPKAN KE SOAL
    </button>
</div>
                    <img id="img-${id}" style="max-width:150px; border-radius:10px; display:none; border:1px solid var(--neon);">
                </div>
                
                <div class="preview-wrapper">
                    <div class="preview-header" onclick="toggleAccordion('${id}')">
                        <span>LIVE PREVIEW MATEMATIKA</span>
                        <span id="status-${id}">Buka ‚ñæ</span>
                    </div>
                    <div id="live-preview-${id}" class="live-math-preview">
                        <span style="opacity:0.5; font-size:12px;">Pratinjau matematika otomatis...</span>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:20px; align-items:center; margin-top:15px; flex-wrap:wrap;">
                <input type="file" accept="image/*" style="width:auto; font-size:10px;" onchange="handleImageSoal('${id}', this)">
                <div style="flex:1; min-width: 150px;">
                    <label style="font-size:10px;">UKURAN GAMBAR</label>
                    <input type="range" min="50" max="500" value="200" style="width:100%" oninput="updateImageSize('${id}', this.value)">
                </div>
            </div>
        `;
        document.getElementById("containerSoal").appendChild(div);
        listSoal.push({ id: id, teks: "", gambar: null, lebar: 200, targetKelas: [] });
    }

    function updateSoalTeks(id, val) { const soal = listSoal.find(s => s.id == id); if(soal) soal.teks = val; }
    
    function updateSoalKelas(id) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) {
            const container = document.getElementById(`cb-group-${id}`);
            soal.targetKelas = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
        }
    }
    
    function updateImageSize(id, val) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) soal.lebar = parseInt(val);
        const imgPrev = document.getElementById(`img-${id}`);
        if(imgPrev) imgPrev.style.width = val + "px";
    }
    
    function handleImageSoal(id, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const optimizedDataUrl = canvas.toDataURL("image/jpeg", 0.7);
                const soal = listSoal.find(s => s.id == id);
                if(soal) soal.gambar = optimizedDataUrl;
                const imgPrev = document.getElementById(`img-${id}`);
                imgPrev.src = optimizedDataUrl;
                imgPrev.style.display = "block";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function hapusInputSoal(id) { document.getElementById(`item-${id}`).remove(); listSoal = listSoal.filter(s => s.id != id); }
  
  
function resetTableInputs(id) {
    const container = document.getElementById(`tb-grid-${id}`);
    if (!container) return;

    const inputs = container.querySelectorAll("input");
    inputs.forEach(input => input.value = "");
}
    function generateQRAsync(text) {
        return new Promise((resolve) => {
            const temp = document.createElement("div");
            new QRCode(temp, { text: text, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            setTimeout(() => {
                const img = temp.querySelector("img");
                if (!img) return resolve("");
                const canvas = document.createElement("canvas");
                canvas.width = 128; canvas.height = 128;
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,128,128);
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL());
            }, 50);
        });
    }

    async function tambahManual() {
        const n = document.getElementById("nama").value;
        const k = document.getElementById("kelas").value.toUpperCase();
        const m = document.getElementById("mapel").value;
        const r = document.getElementById("ruangan").value;
        if(!n || !k) return alert("Nama dan Kelas wajib diisi!");
        const qr = await generateQRAsync(n);
        dataPeserta.push({ nama: n, kelas: k, mapel: m || '-', ruangan: r || '-', qr: qr });
        renderPeserta();
        document.getElementById("nama").value = "";
        document.getElementById("nama").focus();
    }

function toggleTableInput(id) {
    const panel = document.getElementById(`table-builder-${id}`);
    const grid = document.getElementById(`tb-grid-${id}`);

    if (!panel) return;

    if (panel.style.display === "none" || panel.style.display === "") {
        panel.style.display = "block";
    } else {
        panel.style.display = "none";
        if (grid) grid.innerHTML = "";
    }
}

    function renderPeserta() {
        const container = document.getElementById("daftarPeserta");
        container.innerHTML = dataPeserta.map((p, i) => `
            <div class="peserta-card animate__animated animate__fadeIn">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <span style="background: var(--neon2); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px;">#${i + 1}</span>
                    <button onclick="hapusPeserta(${i})" style="background:var(--danger); padding:2px 8px; margin:0; border-radius: 5px;">‚úï</button>
                </div>
                <b style="color:var(--neon); display: block; margin-top: 5px;">${p.nama}</b>
                <div style="font-size: 11px; margin-top: 4px; opacity: 0.9;">
                    <span>üìç Ruang: <b>${p.ruangan}</b></span><br>
                    <span>üìö ${p.kelas} ‚Ä¢ ${p.mapel}</span>
                </div>
            </div>
        `).join("");
    }

    function hapusPeserta(i) { dataPeserta.splice(i, 1); renderPeserta(); }
    function resetData() { if(confirm("Hapus semua data peserta?")) { dataPeserta = []; renderPeserta(); } }

    async function importExcel() {
        const fileInput = document.getElementById("fileExcel");
        const f = fileInput.files[0];
        if(!f) return alert("Pilih file excel!");
        const overlay = document.getElementById("loadingOverlay");
        const progressText = document.getElementById("progressText");
        const progressCount = document.getElementById("progressCount");
        const importBtn = document.getElementById("importBtn");
        overlay.style.display = "flex";
        importBtn.disabled = true;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: "array"});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const total = rows.length;
                for (let i = 0; i < total; i++) {
                    const r = rows[i];
                    const n = r.Nama || r.nama || r.NAMA;
                    const k = (r.Kelas || r.kelas || r.KELAS || "").toString().toUpperCase().trim();
                    if (n && k) {
                        const qr = await generateQRAsync(n.toString());
                        dataPeserta.push({
                            nama: n, kelas: k, 
                            mapel: r.Mata_Pelajaran || r.mapel || r.MAPEL || '-', 
                            ruangan: r.Ruangan || r.ruangan || r.RUANGAN || '-', 
                            qr: qr
                        });
                    }
                    if (i % 5 === 0 || i === total - 1) {
                        const percent = Math.round(((i + 1) / total) * 100);
                        progressText.innerText = percent + "%";
                        progressCount.innerText = `${i + 1} / ${total} Data`;
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                }
                renderPeserta();
                alert(`Berhasil mengimpor ${dataPeserta.length} data.`);
            } catch (err) { alert("Gagal membaca file Excel!"); }
            finally { overlay.style.display = "none"; importBtn.disabled = false; fileInput.value = ""; }
        };
        reader.readAsArrayBuffer(f);
    }

    function filterSoalValidUntukKelas(kelasPeserta) {
        const kP = kelasPeserta.trim().toUpperCase();
        return listSoal.filter(s => {
            const matchKelas = s.targetKelas.length === 0 || s.targetKelas.some(target => target.toUpperCase() === kP);
            const hasContent = (s.teks && s.teks.trim() !== "") || s.gambar !== null;
            return matchKelas && hasContent;
        });
    }

    function preview() {
        if(!dataPeserta.length) return alert("Belum ada data peserta!");
        let html = "";
        let countTerpakai = 0;
        dataPeserta.forEach(p => {
            const soalTersaring = filterSoalValidUntukKelas(p.kelas);
            if(soalTersaring.length === 0) return; 
            countTerpakai++;
            html += `<div class="page pdf-page" style="padding:20px; border-bottom:2px dashed #ccc; margin-bottom: 20px; color: #000; background: #fff;">
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:5px; margin-bottom:10px;">
                    <div>
                        <h1 style="margin:0; font-size:18px;">${p.nama.toUpperCase()}</h1>
                        <p style="margin:2px 0; font-size:12px;">MAPEL: <b>${p.mapel}</b> | KELAS: ${p.kelas} | RUANG: ${p.ruangan}</p>
                    </div>
                    <img src="${p.qr}" width="60" style="border:1px solid #000; padding:2px;">
                </div>`;
            html += soalTersaring.map((s, idx) => `
                <div class="soal-print-item">
                    <small style="color:#666; font-size:9px; display:block;">SOAL ${idx+1}</small>
                    <div class="math-render-area" style="margin:5px 0; font-size:16px; line-height:1.5;">
                        ${s.teks ? s.teks.replace(/\n/g, '<br>') : ''}
                    </div>
                    ${s.gambar ? `<img src="${s.gambar}" style="width:${s.lebar}px; margin-top:5px; display:block;">` : ''}
                </div>
            `).join("");
            html += `</div>`;
        });
        if(countTerpakai === 0) {
            alert("Tidak ada konten soal yang valid untuk ditampilkan!");
            document.getElementById("previewArea").innerHTML = "";
            return;
        }
        const previewArea = document.getElementById("previewArea");
        previewArea.innerHTML = html;
        if (window.MathJax) {
            MathJax.typesetPromise([previewArea]).catch((err) => console.log(err));
        }
        window.scrollTo({ top: previewArea.offsetTop, behavior: 'smooth' });
    }

    async function exportPDF() {
    if (!dataPeserta.length) return alert("Belum ada data peserta!");
    
    // Pastikan pratinjau sudah dirender untuk dipotret
    preview();
    
    const overlay = document.getElementById("loadingOverlay");
    const progressText = document.getElementById("progressText");
    overlay.style.display = "flex";
    progressText.innerText = "MENYIAPKAN PDF...";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Mengambil semua elemen halaman pratinjau
    const pages = document.querySelectorAll("#previewArea .pdf-page");
    
    for (let i = 0; i < pages.length; i++) {
        progressText.innerText = `MEMPROSES HALAMAN ${i + 1}...`;
        
        const canvas = await html2canvas(pages[i], {
            scale: 2, // Kualitas tinggi
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff"
        });
        
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        if (i > 0) doc.addPage();
        doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
    }

    doc.save(`Soal_Ujian_${new Date().getTime()}.pdf`);
    overlay.style.display = "none";
}
  
  async function exportPDF() {
    if (!dataPeserta.length) return alert("Belum ada data peserta!");
    
    // Pastikan pratinjau sudah dirender untuk dipotret
    preview();
    
    const overlay = document.getElementById("loadingOverlay");
    const progressText = document.getElementById("progressText");
    overlay.style.display = "flex";
    progressText.innerText = "MENYIAPKAN PDF...";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Mengambil semua elemen halaman pratinjau
    const pages = document.querySelectorAll("#previewArea .pdf-page");
    
    for (let i = 0; i < pages.length; i++) {
        progressText.innerText = `MEMPROSES HALAMAN ${i + 1}...`;
        
        const canvas = await html2canvas(pages[i], {
            scale: 2, // Kualitas tinggi
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff"
        });
        
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        if (i > 0) doc.addPage();
        doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
    }

    doc.save(`Soal_Ujian_${new Date().getTime()}.pdf`);
    overlay.style.display = "none";
}
  
  async function getBase64FromUrl(dataUrl) {
    if (!dataUrl) return null;
    return dataUrl.split(',')[1];
}


  async function exportWord() {
    // 1. Validasi Data
    if (!dataPeserta || dataPeserta.length === 0) {
        return alert("Belum ada data peserta untuk diekspor!");
    }

    // 2. Pastikan library docx tersedia
    if (!window.docx) {
        return alert("Library docx belum terload sempurna. Pastikan koneksi internet aktif.");
    }

    const { Document, Packer, Paragraph, TextRun, ImageRun, Table, TableRow, TableCell, WidthType, BorderStyle, VerticalAlign, AlignmentType } = window.docx;
    const sections = [];

    try {
        for (const p of dataPeserta) {
            const soalTersaring = filterSoalValidUntukKelas(p.kelas);
            if (soalTersaring.length === 0) continue;

            const children = [];

            // --- HEADER DENGAN TABEL (QR DI KANAN) ---
            const qrClean = p.qr.includes(",") ? p.qr.split(",")[1] : p.qr;
            
            const headerTable = new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                borders: {
                    top: { style: BorderStyle.NONE },
                    bottom: { style: BorderStyle.SINGLE, size: 6, color: "000000" },
                    left: { style: BorderStyle.NONE },
                    right: { style: BorderStyle.NONE },
                    insideHorizontal: { style: BorderStyle.NONE },
                    insideVertical: { style: BorderStyle.NONE },
                },
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({
                                width: { size: 80, type: WidthType.PERCENTAGE },
                                verticalAlign: VerticalAlign.CENTER,
                                children: [
                                    new Paragraph({
                                        children: [new TextRun({ text: p.nama.toUpperCase(), bold: true, size: 28 })]
                                    }),
                                    new Paragraph({
                                        children: [new TextRun({ text: `MAPEL: ${p.mapel} | KELAS: ${p.kelas} | RUANG: ${p.ruangan}`, size: 18 })]
                                    }),
                                ],
                            }),
                            new TableCell({
                                width: { size: 20, type: WidthType.PERCENTAGE },
                                verticalAlign: VerticalAlign.CENTER,
                                children: [
                                    new Paragraph({
                                        alignment: AlignmentType.RIGHT,
                                        children: [
                                            new ImageRun({
                                                data: Uint8Array.from(atob(qrClean), c => c.charCodeAt(0)),
                                                transformation: { width: 60, height: 60 },
                                            }),
                                        ],
                                    }),
                                ],
                            }),
                        ],
                    }),
                ],
            });

            children.push(headerTable);

            // --- ISI SOAL ---
            for (let i = 0; i < soalTersaring.length; i++) {
                const s = soalTersaring[i];
                
                // Label No Soal
                children.push(new Paragraph({
                    children: [new TextRun({ text: `SOAL ${i + 1}`, size: 16, color: "666666", italics: true })],
                    spacing: { before: 200 }
                }));

                // Teks Soal
                if (s.teks) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: s.teks, size: 22 })],
                        spacing: { after: 100 }
                    }));
                }

                // Gambar Soal (Jika Ada)
                if (s.gambar) {
                    const imgData = s.gambar.split(",")[1];
                    const dim = await getImageDimensions(s.gambar);
                    const ratio = dim.h / dim.w;
                    const displayWidth = s.lebar || 200;
                    
                    children.push(new Paragraph({
                        children: [
                            new ImageRun({
                                data: Uint8Array.from(atob(imgData), c => c.charCodeAt(0)),
                                transformation: { width: displayWidth, height: displayWidth * ratio },
                            }),
                        ],
                    }));
                }
            }

            // Tambahkan Page Break kecuali untuk peserta terakhir
            sections.push({ 
                properties: { type: window.docx.SectionType.NEXT_PAGE },
                children: children 
            });
        }

        // 3. Generate File
        const doc = new Document({ sections });
        const blob = await Packer.toBlob(doc);
        saveAs(blob, `Soal_CyberQR_${Date.now()}.docx`);

    } catch (error) {
        console.error("Error generating Word:", error);
        alert("Terjadi kesalahan teknis saat membuat file Word. Periksa console log.");
    }
}
</script>

</body>
</html>
