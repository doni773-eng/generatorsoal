<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>CyberQR - Soal Multi-Kelas Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --neon: #00f2ff;
            --neon2: #7000ff;
            --danger: #ff0055;
            --success: #00ff88;
            --bg-main: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            --bg-container: rgba(15, 23, 42, 0.7);
            --bg-section: rgba(2, 6, 23, 0.4);
            --text-main: #f8fafc;
            --border: rgba(0, 242, 255, 0.3);
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --bg-main: radial-gradient(circle at center, #f1f5f9 0%, #cbd5e1 100%);
            --bg-container: rgba(255, 255, 255, 0.8);
            --bg-section: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --border: rgba(112, 0, 255, 0.3);
            --input-bg: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background: var(--bg-main);
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            padding: 40px 0;
            overflow-x: hidden;
        }

        .theme-switch {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: var(--neon2); color: white; border: none;
            padding: 10px 15px; border-radius: 50px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 8px;
        }

        .container {
            width: 1100px; max-width: 95%; background: var(--bg-container);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 30px;
            padding: 40px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
            animation: fadeInDown 0.8s;
        }

        h2 {
            text-align: center; font-size: 2.5rem; letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--neon), var(--neon2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        .section {
            margin-top: 30px; padding: 25px; border-radius: 20px;
            background: var(--bg-section); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }

        .section h3 { margin: 0 0 20px; font-size: 18px; text-transform: uppercase; color: var(--neon2); }

        input[type="text"], input[type="file"], textarea {
            width: 100%; margin-top: 10px; padding: 14px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--input-bg);
            color: var(--text-main); outline: none;
        }

        button {
            margin-top: 12px; padding: 12px 24px; border-radius: 12px;
            border: none; font-weight: 700; text-transform: uppercase;
            font-size: 11px; cursor: pointer;
            background: linear-gradient(135deg, var(--neon), var(--neon2)); color: white;
        }

        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(112, 0, 255, 0.4); }

        .peserta-card {
            background: rgba(112, 0, 255, 0.05); padding: 15px;
            border-radius: 15px; border: 1px solid var(--border);
        }

        .cb-label {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--input-bg); padding: 6px 14px;
            border-radius: 8px; cursor: pointer; font-size: 11px;
        }

        .page {
            width: 794px; background: #fff; color: #333;
            margin: 20px auto; border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .soal-print-item {
            border-bottom: 1px dotted #ccc;
            padding: 5px 0;
            margin-bottom: 2px;
        }
        
        .soal-print-item p {
            margin: 2px 0;
            line-height: 1.2;
        }

        .soal-print-item:last-child { border-bottom: none; }
        
        .excel-btn { background: #10b981; }
        .reset-btn { background: var(--danger); }
        .pdf-btn { background: #e11d48; }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            .page { width: 100% !important; }
        }
    </style>
</head>
<body>

<button class="theme-switch" onclick="toggleTheme()" id="themeBtn">
    <span id="themeIcon">üåô</span> <span id="themeText">Mode Gelap</span>
</button>

<div class="container">
    <h2><span style="font-weight: 200;">CORE</span> GENERATOR</h2>
    <p style="text-align: center; margin-top: -30px; font-size: 12px;">Created By: Doni Stiawan</p>

    <div class="section">
        <h3>01. Database & Konfigurasi</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px;">
            <input type="file" id="fileExcel" accept=".xlsx,.xls">
            <button onclick="importExcel()" class="excel-btn">Impor Database (XLSX)</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Matriks Kelas Aktif:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="customKelasInput" value="X MIPA, X IPS, XI MIPA, XI IPS, XII MIPA, XII IPS">
                <button onclick="updateMasterKelas()" style="background: var(--neon2);">Sinkron</button>
            </div>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 242, 255, 0.1); border-radius: 12px; border: 1px dashed var(--neon);">
            <label style="font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--neon);">Update Massal Mata Pelajaran:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="globalMapel" placeholder="Ketik Mapel Baru untuk SEMUA peserta...">
                <button onclick="updateSemuaMapel()" style="background: var(--success); color: #000; min-width: 150px;">Ubah Semua Mapel</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px;">
            <input type="text" id="nama" placeholder="Nama Lengkap">
            <input type="text" id="kelas" placeholder="Kelas">
            <input type="text" id="mapel" placeholder="Mata Pelajaran">
            <input type="text" id="ruangan" placeholder="Ruangan">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="tambahManual()" style="flex: 2;">Tambah Peserta</button>
            <button onclick="resetData()" class="reset-btn" style="flex: 1;">Hapus Semua Data</button>
        </div>
        <div id="daftarPeserta" style="margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px;"></div>
    </div>

    <div class="section">
        <h3>02. Pertanyaan</h3>
        <p style="font-size: 11px; opacity: 0.7; margin-top: -10px;">Pilih target kelas spesifik atau kosongkan untuk semua kelas.</p>
        <div id="containerSoal"></div>
        <button onclick="tambahInputSoal()" style="width: 100%; background: #0ea5e9;">+ TAMBAHKAN SOAL BARU</button>
    </div>

    <div class="section" style="display: flex; gap: 10px; background: transparent; border: none; flex-wrap: wrap;">
        <button onclick="preview()" style="flex: 1; background: #334155; font-size: 16px;">01. Pratinjau</button>
        <button onclick="exportWord()" style="flex: 1; font-size: 16px; background: var(--neon2);">02. Ekspor Word</button>
        <button onclick="exportPDF()" class="pdf-btn" style="flex: 1; font-size: 16px;">03. Ekspor PDF</button>
    </div>

    <div id="previewArea"></div>
</div>

<script>
    let dataPeserta = [];
    let listSoal = [];
    let OPSI_KELAS = ["X MIPA", "X IPS", "XI MIPA", "XI IPS", "XII MIPA", "XII IPS"];

    function toggleTheme() {
        const html = document.documentElement;
        const btnText = document.getElementById("themeText");
        const btnIcon = document.getElementById("themeIcon");
        if (html.getAttribute("data-theme") === "dark") {
            html.setAttribute("data-theme", "light");
            btnText.innerText = "Mode Terang"; btnIcon.innerText = "‚òÄÔ∏è";
        } else {
            html.setAttribute("data-theme", "dark");
            btnText.innerText = "Mode Gelap"; btnIcon.innerText = "üåô";
        }
    }

    // FITUR BARU: LOGIKA UPDATE SEMUA MAPEL
    function updateSemuaMapel() {
        const mapelBaru = document.getElementById("globalMapel").value.trim();
        if(!mapelBaru) return alert("Masukkan nama mata pelajaran terlebih dahulu!");
        if(dataPeserta.length === 0) return alert("Belum ada data peserta yang bisa diubah!");
        
        if(confirm(`Ubah semua mata pelajaran menjadi "${mapelBaru}"?`)) {
            dataPeserta.forEach(p => {
                p.mapel = mapelBaru;
            });
            renderPeserta();
            alert("Berhasil memperbarui semua mata pelajaran.");
            document.getElementById("globalMapel").value = ""; // Clear input setelah update
        }
    }

    function updateMasterKelas() {
        const input = document.getElementById("customKelasInput").value;
        if(!input.trim()) return;
        OPSI_KELAS = input.split(",").map(k => k.trim().toUpperCase()).filter(k => k !== "");
        refreshSemuaCheckboxSoal();
        alert("Matriks Kelas Berhasil Diperbarui");
    }

    function refreshSemuaCheckboxSoal() {
        listSoal.forEach(soal => {
            const container = document.getElementById(`cb-group-${soal.id}`);
            if(container) {
                const prevChecked = soal.targetKelas;
                container.innerHTML = OPSI_KELAS.map(k => `
                    <label class="cb-label">
                        <input type="checkbox" value="${k}" onchange="updateSoalKelas('${soal.id}')" ${prevChecked.includes(k) ? 'checked' : ''}> ${k}
                    </label>
                `).join("");
            }
        });
    }

    function tambahInputSoal() {
        const id = Date.now() + Math.random();
        const div = document.createElement("div");
        div.className = "soal-item animate__animated animate__slideInLeft";
        div.style.cssText = "margin-bottom:20px; padding:20px; border-radius:15px; background:rgba(128,128,128,0.1);";
        div.id = `item-${id}`;
        
        let checkboxesHtml = OPSI_KELAS.map(k => `
            <label class="cb-label">
                <input type="checkbox" value="${k}" onchange="updateSoalKelas('${id}')"> ${k}
            </label>
        `).join("");

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="font-size:10px; font-weight:bold; letter-spacing:2px;">KONFIGURASI SOAL</span>
                <button onclick="hapusInputSoal('${id}')" style="background:var(--danger); padding:5px 10px; margin:0;">Hapus</button>
            </div>
            <div class="checkbox-group" id="cb-group-${id}" style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:5px;">
                ${checkboxesHtml}
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <textarea style="flex:1; min-width: 250px;" placeholder="Masukkan konten soal..." oninput="updateSoalTeks('${id}', this.value)"></textarea>
                <img id="img-${id}" style="max-width:150px; border-radius:10px; display:none; border:1px solid var(--neon);">
            </div>
            <div style="display:flex; gap:20px; align-items:center; margin-top:15px; flex-wrap:wrap;">
                <input type="file" accept="image/*" style="width:auto; font-size:10px;" onchange="handleImageSoal('${id}', this)">
                <div style="flex:1; min-width: 150px;">
                    <label style="font-size:10px;">UKURAN GAMBAR</label>
                    <input type="range" min="50" max="500" value="200" style="width:100%" oninput="updateImageSize('${id}', this.value)">
                </div>
            </div>
        `;
        document.getElementById("containerSoal").appendChild(div);
        listSoal.push({ id: id, teks: "", gambar: null, lebar: 200, targetKelas: [] });
    }

    function updateSoalTeks(id, val) { const soal = listSoal.find(s => s.id == id); if(soal) soal.teks = val; }
    function updateSoalKelas(id) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) {
            const container = document.getElementById(`cb-group-${id}`);
            soal.targetKelas = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
        }
    }
    function updateImageSize(id, val) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) soal.lebar = parseInt(val);
        const imgPrev = document.getElementById(`img-${id}`);
        if(imgPrev) imgPrev.style.width = val + "px";
    }
    function handleImageSoal(id, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const soal = listSoal.find(s => s.id == id);
            if(soal) soal.gambar = e.target.result;
            const imgPrev = document.getElementById(`img-${id}`);
            imgPrev.src = e.target.result; imgPrev.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
    function hapusInputSoal(id) { document.getElementById(`item-${id}`).remove(); listSoal = listSoal.filter(s => s.id != id); }

    function buatQR(text, callback){
        const temp = document.createElement("div");
        new QRCode(temp,{text, width:128, height:128, correctLevel: QRCode.CorrectLevel.H});
        setTimeout(()=>{
            const img = temp.querySelector("img");
            if(!img) return;
            const canvas = document.createElement("canvas");
            canvas.width=128; canvas.height=128;
            const ctx=canvas.getContext("2d");
            ctx.fillStyle="#fff"; ctx.fillRect(0,0,128,128);
            ctx.drawImage(img,0,0);
            callback(canvas.toDataURL());
        },300);
    }

    function tambahManual(){
        const n = document.getElementById("nama").value;
        const k = document.getElementById("kelas").value.toUpperCase();
        const m = document.getElementById("mapel").value;
        const r = document.getElementById("ruangan").value;
        
        if(!n || !k) return alert("Nama dan Kelas wajib diisi!");
        
        buatQR(`${n}`, qr => {
            dataPeserta.push({
                nama: n, 
                kelas: k, 
                mapel: m || '-', 
                ruangan: r || '-', 
                qr
            }); 
            
            renderPeserta();
            document.getElementById("nama").value = "";
            document.getElementById("nama").focus(); 
            console.log("Peserta ditambahkan: " + n);
        });
    }

    function renderPeserta(){
        const container = document.getElementById("daftarPeserta");
        container.innerHTML = dataPeserta.map((p, i) => `
            <div class="peserta-card animate__animated animate__fadeIn">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <span style="background: var(--neon2); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px;">#${i + 1}</span>
                    <button onclick="hapusPeserta(${i})" style="background:var(--danger); padding:2px 8px; margin:0; border-radius: 5px;">‚úï</button>
                </div>
                <b style="color:var(--neon); display: block; margin-top: 5px;">${p.nama}</b>
                <div style="font-size: 11px; margin-top: 4px; opacity: 0.9;">
                    <span>üìç Ruang: <b>${p.ruangan}</b></span><br>
                    <span>üìö ${p.kelas} ‚Ä¢ ${p.mapel}</span>
                </div>
            </div>
        `).join("");
    }

    function hapusPeserta(i) { dataPeserta.splice(i, 1); renderPeserta(); }
    function resetData() { if(confirm("Hapus semua data peserta?")) { dataPeserta = []; renderPeserta(); } }

    function importExcel(){
        const f = document.getElementById("fileExcel").files[0];
        if(!f) return alert("Pilih file excel!");
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(e.target.result,{type:"array"});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            rows.forEach(r => {
                const n = r.Nama || r.nama || r.NAMA;
                const k = (r.Kelas || r.kelas || r.KELAS || "").toString().toUpperCase().trim();
                if(n && k) {
                    buatQR(`${n}`, qr => {
                        dataPeserta.push({nama:n, kelas:k, mapel:r.Mata_Pelajaran||'-', ruangan:r.Ruangan||'-', qr});
                        renderPeserta();
                    });
                }
            });
        };
        reader.readAsArrayBuffer(f);
    }

    function filterSoalValidUntukKelas(kelasPeserta) {
        const kP = kelasPeserta.trim().toUpperCase();
        return listSoal.filter(s => {
            const matchKelas = s.targetKelas.length === 0 || s.targetKelas.some(target => target.toUpperCase() === kP);
            const hasContent = (s.teks && s.teks.trim() !== "") || s.gambar !== null;
            return matchKelas && hasContent;
        });
    }

    function preview() {
        if(!dataPeserta.length) return alert("Belum ada data peserta!");
        let html = "";
        let countTerpakai = 0;

        dataPeserta.forEach(p => {
            const soalTersaring = filterSoalValidUntukKelas(p.kelas);
            if(soalTersaring.length === 0) return; 

            countTerpakai++;
            html += `<div class="page pdf-page" style="padding:20px; border-bottom:2px dashed #ccc; margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:5px; margin-bottom:10px;">
                    <div>
                        <h1 style="margin:0; font-size:18px;">${p.nama.toUpperCase()}</h1>
                        <p style="margin:2px 0; font-size:12px;">MAPEL: <b>${p.mapel}</b> | KELAS: ${p.kelas} | RUANG: ${p.ruangan}</p>
                    </div>
                    <img src="${p.qr}" width="60" style="border:1px solid #000; padding:2px;">
                </div>`;
            
            html += soalTersaring.map((s, idx) => `
                <div class="soal-print-item">
                    <small style="color:#666; font-size:9px; display:block;">SOAL ${idx+1}</small>
                    <p style="margin:0; font-size:14px; line-height:1.2;">${s.teks || ''}</p>
                    ${s.gambar ? `<img src="${s.gambar}" style="width:${s.lebar}px; margin-top:3px; display:block;">` : ''}
                </div>
            `).join("");
            
            html += `</div>`;
        });

        if(countTerpakai === 0) {
            alert("Tidak ada konten soal yang valid untuk ditampilkan!");
            document.getElementById("previewArea").innerHTML = "";
            return;
        }

        document.getElementById("previewArea").innerHTML = html;
        window.scrollTo({ top: document.getElementById("previewArea").offsetTop, behavior: 'smooth' });
    }

    async function exportPDF() {
        const pages = document.querySelectorAll(".pdf-page");
        if (pages.length === 0) return alert("Klik Pratinjau dulu!");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            if (i > 0) pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, (canvas.height * pageWidth) / canvas.width);
        }
        pdf.save(`Soal_${new Date().getTime()}.pdf`);
    }

    async function exportWord() {
        if (!dataPeserta.length) return alert("Data kosong!");
        const { Document, Packer, Paragraph, TextRun, ImageRun, AlignmentType, BorderStyle, Table, TableRow, TableCell, WidthType, PageBreak } = docx;
        const allChildren = [];
        let validExport = false;

        for (let i = 0; i < dataPeserta.length; i++) {
            const p = dataPeserta[i];
            const soalTersaring = filterSoalValidUntukKelas(p.kelas);

            if (soalTersaring.length === 0) continue; 
            
            validExport = true;

            allChildren.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                borders: { bottom: { style: BorderStyle.SINGLE, size: 24 }, top: BorderStyle.NONE, left: BorderStyle.NONE, right: BorderStyle.NONE },
                rows: [new TableRow({
                    children: [
                        new TableCell({
                            width: { size: 80, type: WidthType.PERCENTAGE },
                            children: [
                                new Paragraph({ children: [new TextRun({ text: p.nama.toUpperCase(), bold: true, size: 28 })] }),
                                new Paragraph({ children: [new TextRun({ text: `MAPEL: ${p.mapel} | KELAS: ${p.kelas} | RUANGAN: ${p.ruangan}`, size: 18 })] }),
                            ],
                        }),
                        new TableCell({
                            width: { size: 20, type: WidthType.PERCENTAGE },
                            children: [new Paragraph({ alignment: AlignmentType.RIGHT, children: [ new ImageRun({ data: Uint8Array.from(atob(p.qr.split(",")[1]), c => c.charCodeAt(0)), transformation: { width: 50, height: 50 } }) ] })],
                        }),
                    ],
                })],
            }));

            allChildren.push(new Paragraph({ text: "", spacing: { after: 50 } }));

            for (let idx = 0; idx < soalTersaring.length; idx++) {
                const s = soalTersaring[idx];
                allChildren.push(new Paragraph({ 
                    spacing: { before: 80, after: 0 },
                    children: [new TextRun({ text: `SOAL ${idx + 1}`, bold: true, size: 14, color: "666666" })] 
                }));
                allChildren.push(new Paragraph({ 
                    spacing: { before: 0, after: 30 },
                    children: [new TextRun({ text: s.teks || "", size: 22 })] 
                }));

                if (s.gambar) {
                    const imgData = s.gambar.split(",")[1];
                    allChildren.push(new Paragraph({ 
                        spacing: { after: 30 },
                        children: [ new ImageRun({ data: Uint8Array.from(atob(imgData), c => c.charCodeAt(0)), transformation: { width: s.lebar, height: (s.lebar * 0.7) } }) ] 
                    }));
                }
                allChildren.push(new Paragraph({ border: { bottom: { style: BorderStyle.DOTTED, size: 4, color: "CCCCCC" } }, spacing: { after: 30 } }));
            }
            
            allChildren.push(new Paragraph({ children: [new PageBreak()] }));
        }

        if(!validExport) return alert("Tidak ada data soal yang valid untuk diekspor!");

        allChildren.pop();

        const doc = new Document({ sections: [{ children: allChildren }] });
        Packer.toBlob(doc).then(blob => { saveAs(blob, `Soal Ulangan SMAN 12 Kaur.docx`); });
    }
</script>
</body>
</html>
