<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>CyberQR - Soal Multi-Kelas Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --neon: #00f2ff;
            --neon2: #7000ff;
            --danger: #ff0055;
            --success: #00ff88;
            
            /* Dark Theme Variables (Default) */
            --bg-main: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
            --bg-container: rgba(15, 23, 42, 0.7);
            --bg-section: rgba(2, 6, 23, 0.4);
            --text-main: #f8fafc;
            --border: rgba(0, 242, 255, 0.3);
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --bg-main: radial-gradient(circle at center, #f1f5f9 0%, #cbd5e1 100%);
            --bg-container: rgba(255, 255, 255, 0.8);
            --bg-section: rgba(255, 255, 255, 0.6);
            --text-main: #1e293b;
            --border: rgba(112, 0, 255, 0.3);
            --input-bg: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            background: var(--bg-main);
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            padding: 40px 0;
            overflow-x: hidden;
        }

        /* Theme Toggle Button */
        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--neon2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .container {
            width: 1100px;
            max-width: 95%;
            background: var(--bg-container);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
            animation: fadeInDown 0.8s;
        }

        h2 {
            text-align: center;
            font-size: 2.5rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--neon), var(--neon2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        .section {
            margin-top: 30px;
            padding: 25px;
            border-radius: 20px;
            background: var(--bg-section);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .section h3 {
            margin: 0 0 20px;
            font-size: 18px;
            text-transform: uppercase;
            color: var(--neon2);
        }

        input[type="text"], input[type="file"], textarea {
            width: 100%;
            margin-top: 10px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-main);
            outline: none;
        }

        button {
            margin-top: 12px;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            cursor: pointer;
            background: linear-gradient(135deg, var(--neon), var(--neon2));
            color: white;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(112, 0, 255, 0.4);
        }

        .peserta-card {
            background: rgba(112, 0, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .cb-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--input-bg);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            border: 1px solid transparent;
        }

        .cb-label:has(input:checked) {
            border: 1px solid var(--neon2);
            background: rgba(112, 0, 255, 0.1);
        }

        .page {
            width: 794px; background: #fff; color: #333;
            margin: 40px auto; border-radius: 10px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.2);
        }
        
        .excel-btn { background: #10b981; }
        .reset-btn { background: var(--danger); }
        .pdf-btn { background: #e11d48; }

/* --- RESPONSIVE MOBILE FIX --- */
@media (max-width: 768px) {
    body {
        padding: 10px 0; /* Kurangi padding luar di mobile */
    }

    .container {
        padding: 20px; /* Padding dalam lebih kecil */
        border-radius: 15px; /* Radius lebih kecil agar tidak makan tempat */
    }

    h2 {
        font-size: 1.8rem; /* Judul lebih kecil di HP */
        letter-spacing: 2px;
    }

    /* Ubah grid 2 kolom menjadi 1 kolom di mobile */
    .section div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important; 
        gap: 10px !important;
    }

    /* Tombol-tombol di bagian bawah agar bertumpuk rapi */
    .section[style*="display: flex"] {
        flex-direction: column;
    }

    .section[style*="display: flex"] button {
        width: 100%;
        margin-bottom: 5px;
    }

    /* Perbaikan Area Pratinjau (Page) */
    .page {
        width: 100% !important; /* Paksa lebar 100% di layar kecil */
        margin: 10px 0;
        padding: 15px !important;
        box-shadow: none;
        border: 1px solid #ddd;
    }

    /* Header pratinjau agar tidak berantakan */
    .page div[style*="display:flex"] {
        flex-direction: column-reverse; /* QR di bawah Nama atau sebaliknya */
        align-items: center;
        text-align: center;
        gap: 15px;
    }

    /* Input gambar & range di bagian soal */
    .soal-item div[style*="display:flex"] {
        flex-direction: column;
    }

    /* Ukuran teks input */
    input, textarea, button {
        font-size: 14px !important;
    }

    /* Posisi tombol theme switch di mobile */
    .theme-switch {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 12px;
    }
}
    </style>
</head>
<body>

<button class="theme-switch" onclick="toggleTheme()" id="themeBtn">
    <span id="themeIcon">ðŸŒ™</span> <span id="themeText">Mode Gelap</span>
</button>

<div class="container">
    <h2><span style="font-weight: 200;">CORE</span> GENERATOR</h2>
    <p style="text-align: center; margin-top: -30px; font-size: 12px;">Created By: Doni Stiawan</p>

    <div class="section">
        <h3>01. Database & Konfigurasi</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px;">
            <input type="file" id="fileExcel" accept=".xlsx,.xls">
            <button onclick="importExcel()" class="excel-btn">Impor Database (XLSX)</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="font-size: 11px; font-weight: bold; text-transform: uppercase;">Matriks Kelas Aktif:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="customKelasInput" value="X MIPA, X IPS, XI MIPA, XI IPS, XII MIPA, XII IPS">
                <button onclick="updateMasterKelas()" style="background: var(--neon2);">Sinkron</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
            <input type="text" id="nama" placeholder="Nama Lengkap">
            <input type="text" id="kelas" placeholder="Kelas">
            <input type="text" id="ruangan" placeholder="Ruangan">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="tambahManual()" style="flex: 2;">Tambah Peserta</button>
            <button onclick="resetData()" class="reset-btn" style="flex: 1;">Hapus Semua Data</button>
        </div>
        <div id="daftarPeserta" style="margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px;"></div>
    </div>

    <div class="section">
        <h3>02. Pertanyaan</h3>
        <p style="font-size: 11px; opacity: 0.7; margin-top: -10px;">Pilih target kelas spesifik atau kosongkan untuk semua kelas.</p>
        <div id="containerSoal"></div>
        <button onclick="tambahInputSoal()" style="width: 100%; background: #0ea5e9;">+ TAMBAHKAN SOAL BARU</button>
    </div>

    <div class="section" style="display: flex; gap: 10px; background: transparent; border: none; flex-wrap: wrap;">
        <button onclick="preview()" style="flex: 1; background: #334155; font-size: 16px;">01. Pratinjau</button>
        <button onclick="exportWord()" style="flex: 1; font-size: 16px; background: var(--neon2);">02. Ekspor Word</button>
        <button onclick="exportPDF()" class="pdf-btn" style="flex: 1; font-size: 16px;">03. Ekspor PDF</button>
    </div>

    <div id="previewArea"></div>
</div>

<script>
    // --- FITUR DARK/LIGHT MODE ---
    function toggleTheme() {
        const html = document.documentElement;
        const btnText = document.getElementById("themeText");
        const btnIcon = document.getElementById("themeIcon");
        
        if (html.getAttribute("data-theme") === "dark") {
            html.setAttribute("data-theme", "light");
            btnText.innerText = "Mode Terang";
            btnIcon.innerText = "â˜€ï¸";
            localStorage.setItem("theme", "light");
        } else {
            html.setAttribute("data-theme", "dark");
            btnText.innerText = "Mode Gelap";
            btnIcon.innerText = "ðŸŒ™";
            localStorage.setItem("theme", "dark");
        }
    }

    // Load saved theme
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    if(savedTheme === "light") {
        document.getElementById("themeText").innerText = "Mode Terang";
        document.getElementById("themeIcon").innerText = "â˜€ï¸";
    }

    // --- LOGIKA CORE GENERATOR ---
    let dataPeserta = [];
    let listSoal = [];
    let OPSI_KELAS = ["X MIPA", "X IPS", "XI MIPA", "XI IPS", "XII MIPA", "XII IPS"];

    function updateMasterKelas() {
        const input = document.getElementById("customKelasInput").value;
        if(!input.trim()) return;
        OPSI_KELAS = input.split(",").map(k => k.trim().toUpperCase()).filter(k => k !== "");
        refreshSemuaCheckboxSoal();
        alert("Matriks Kelas Berhasil Diperbarui");
    }

    function refreshSemuaCheckboxSoal() {
        listSoal.forEach(soal => {
            const container = document.getElementById(`cb-group-${soal.id}`);
            if(container) {
                const prevChecked = soal.targetKelas;
                container.innerHTML = OPSI_KELAS.map(k => `
                    <label class="cb-label">
                        <input type="checkbox" value="${k}" onchange="updateSoalKelas('${soal.id}')" ${prevChecked.includes(k) ? 'checked' : ''}> ${k}
                    </label>
                `).join("");
            }
        });
    }

    function tambahInputSoal() {
        const id = Date.now() + Math.random();
        const div = document.createElement("div");
        div.className = "soal-item animate__animated animate__slideInLeft";
        div.style.marginBottom = "20px";
        div.style.padding = "20px";
        div.style.borderRadius = "15px";
        div.style.background = "rgba(128,128,128,0.1)";
        div.id = `item-${id}`;
        
        let checkboxesHtml = OPSI_KELAS.map(k => `
            <label class="cb-label">
                <input type="checkbox" value="${k}" onchange="updateSoalKelas('${id}')"> ${k}
            </label>
        `).join("");

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="font-size:10px; font-weight:bold; letter-spacing:2px;">KONFIGURASI SOAL</span>
                <button onclick="hapusInputSoal('${id}')" style="background:var(--danger); padding:5px 10px; margin:0;">Hapus</button>
            </div>
            <div class="checkbox-group" id="cb-group-${id}" style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:5px;">
                ${checkboxesHtml}
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <textarea style="flex:1; min-width: 250px;" placeholder="Masukkan konten soal..." oninput="updateSoalTeks('${id}', this.value)"></textarea>
                <img id="img-${id}" style="max-width:150px; border-radius:10px; display:none; border:1px solid var(--neon);">
            </div>
            <div style="display:flex; gap:20px; align-items:center; margin-top:15px; flex-wrap:wrap;">
                <input type="file" accept="image/*" style="width:auto; font-size:10px;" onchange="handleImageSoal('${id}', this)">
                <div style="flex:1; min-width: 150px;">
                    <label style="font-size:10px;">UKURAN GAMBAR</label>
                    <input type="range" min="50" max="500" value="200" style="width:100%" oninput="updateImageSize('${id}', this.value)">
                </div>
            </div>
        `;
        document.getElementById("containerSoal").appendChild(div);
        listSoal.push({ id: id, teks: "", gambar: null, lebar: 200, targetKelas: [] });
    }

    function updateSoalTeks(id, val) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) soal.teks = val;
    }

    function updateSoalKelas(id) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) {
            const container = document.getElementById(`cb-group-${id}`);
            const checked = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
            soal.targetKelas = checked;
        }
    }

    function updateImageSize(id, val) {
        const soal = listSoal.find(s => s.id == id);
        if(soal) soal.lebar = parseInt(val);
        const imgPrev = document.getElementById(`img-${id}`);
        if(imgPrev) imgPrev.style.width = val + "px";
    }

    function handleImageSoal(id, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Data = e.target.result;
            const soal = listSoal.find(s => s.id == id);
            if(soal) soal.gambar = base64Data;
            const imgPrev = document.getElementById(`img-${id}`);
            imgPrev.src = base64Data;
            imgPrev.style.display = "block";
        };
        reader.readAsDataURL(file);
    }

    function hapusInputSoal(id) {
        document.getElementById(`item-${id}`).remove();
        listSoal = listSoal.filter(s => s.id != id);
    }

    function buatQR(text, callback){
        const temp = document.createElement("div");
        new QRCode(temp,{text, width:128, height:128, correctLevel: QRCode.CorrectLevel.H});
        setTimeout(()=>{
            const img = temp.querySelector("img");
            if(!img) return;
            const canvas = document.createElement("canvas");
            canvas.width=128; canvas.height=128;
            const ctx=canvas.getContext("2d");
            ctx.fillStyle="#fff"; ctx.fillRect(0,0,128,128);
            ctx.drawImage(img,0,0);
            callback(canvas.toDataURL());
        },300);
    }

    function tambahManual(){
        const n = document.getElementById("nama").value;
        const k = document.getElementById("kelas").value.toUpperCase();
        const r = document.getElementById("ruangan").value;
        if(!n || !k) return alert("Nama dan Kelas wajib diisi!");
        
        buatQR(`${n}`, qr => {
            dataPeserta.push({nama:n, kelas:k, ruangan:r||'-', qr});
            renderPeserta();
            document.getElementById("nama").value = "";
        });
    }

    function renderPeserta(){
        const container = document.getElementById("daftarPeserta");
        container.innerHTML = dataPeserta.map((p, i) => `
            <div class="peserta-card">
                <b style="color:var(--neon2)">${p.nama}</b><br>
                <small>${p.kelas} â€¢ Ruang ${p.ruangan}</small>
                <button onclick="hapusPeserta(${i})" style="background:var(--danger); padding:2px 8px; margin-left:10px;">âœ•</button>
            </div>
        `).join("");
    }

    function hapusPeserta(i) {
        dataPeserta.splice(i, 1);
        renderPeserta();
    }

    function resetData() {
        if(confirm("Hapus semua data peserta?")) {
            dataPeserta = [];
            renderPeserta();
        }
    }

    function importExcel(){
        const f = document.getElementById("fileExcel").files[0];
        if(!f) return alert("Pilih file excel!");
        const reader = new FileReader();
        reader.onload = e => {
            const wb = XLSX.read(e.target.result,{type:"array"});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            rows.forEach(r => {
                const n = r.Nama || r.nama || r.NAMA;
                const k = (r.Kelas || r.kelas || r.KELAS || "").toString().toUpperCase().trim();
                const ru = r.Ruangan || r.ruangan || '-';
                if(n && k) {
                    buatQR(`${n}`, qr => {
                        dataPeserta.push({nama:n, kelas:k, ruangan:ru, qr});
                        renderPeserta();
                    });
                }
            });
        };
        reader.readAsArrayBuffer(f);
    }

    function filterSoalUntukKelas(kelasPeserta) {
        const kP = kelasPeserta.trim().toUpperCase();
        return listSoal.filter(s => {
            if (s.targetKelas.length === 0) return true;
            return s.targetKelas.some(target => target.toUpperCase() === kP);
        });
    }

    function preview() {
        if(!dataPeserta.length) return alert("Belum ada data peserta!");
        let html = "";
        dataPeserta.forEach(p => {
            const soalTersaring = filterSoalUntukKelas(p.kelas);
            html += `<div class="page pdf-page" style="padding:40px; border-bottom:2px dashed #ccc; margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; border-bottom:3px solid #000; padding-bottom:10px; margin-bottom:20px;">
                    <div>
                        <h1 style="margin:0; font-size:22px;">${p.nama.toUpperCase()}</h1>
                        <p style="margin:5px 0;">KELAS: ${p.kelas} | RUANG: ${p.ruangan}</p>
                    </div>
                    <img src="${p.qr}" width="80" style="border:1px solid #000; padding:2px;">
                </div>`;
            
            if(soalTersaring.length === 0) {
                html += `<p style="text-align:center; color:#999; margin:50px 0;">- Tidak ada soal untuk kelas ini -</p>`;
            } else {
                html += soalTersaring.map((s, idx) => `
                    <div style="border:1px solid #000; padding:15px; margin-bottom:15px; border-radius:5px;">
                        <small style="color:#666">SOAL ${idx+1}</small>
                        <p style="margin:10px 0; font-size:16px;">${s.teks || '...'}</p>
                        ${s.gambar ? `<img src="${s.gambar}" style="width:${s.lebar}px; margin-top:10px;">` : ''}
                    </div>
                `).join("");
            }
            html += `</div>`;
        });
        document.getElementById("previewArea").innerHTML = html;
        window.scrollTo({ top: document.getElementById("previewArea").offsetTop, behavior: 'smooth' });
    }

    // --- FITUR BARU: EXPORT PDF ---
    // --- PERBAIKAN FITUR EXPORT PDF ---
    async function exportPDF() {
        const previewArea = document.getElementById("previewArea");
        const pages = previewArea.querySelectorAll(".pdf-page");

        if (pages.length === 0) {
            alert("Silakan klik tombol 'Pratinjau' terlebih dahulu!");
            return;
        }

        const { jsPDF } = window.jspdf;
        // Gunakan format A4
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        alert("Sedang memproses PDF, mohon tunggu...");

        for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], {
                scale: 2, // Tetap gunakan scale 2 untuk ketajaman teks
                useCORS: true,
                logging: false,
                backgroundColor: "#ffffff" // Pastikan background putih
            });

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            
            // Hitung rasio agar gambar tidak gepeng atau terpotong
            const imgProps = pdf.getImageProperties(imgData);
            const pdfImgHeight = (imgProps.height * pageWidth) / imgProps.width;

            if (i > 0) pdf.addPage();
            
            // Masukkan gambar dengan lebar menyesuaikan halaman (pageWidth) 
            // dan tinggi proporsional (pdfImgHeight)
            pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pdfImgHeight);
        }

        pdf.save(`Soal Ulangan SMAN 12 KAUR${new Date().getTime()}.pdf`);
        alert("PDF Berhasil diunduh!");
    }

   async function exportWord() {
        if (!dataPeserta.length) return alert("Data peserta kosong!");
        
        // Proteksi jika library belum terload
        if (typeof docx === 'undefined') return alert("Library docx belum siap.");

        const { Document, Packer, Paragraph, TextRun, ImageRun, AlignmentType, BorderStyle, Table, TableRow, TableCell, WidthType, PageBreak } = docx;

        const allChildren = [];

        for (let i = 0; i < dataPeserta.length; i++) {
            const p = dataPeserta[i];
            const soalTersaring = filterSoalUntukKelas(p.kelas);

            // --- HEADER PESERTA (Tabel Nama & QR) ---
            allChildren.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                borders: {
                    bottom: { style: BorderStyle.SINGLE, size: 24, color: "000000" },
                    top: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE },
                },
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({
                                width: { size: 80, type: WidthType.PERCENTAGE },
                                children: [
                                    new Paragraph({
                                        children: [new TextRun({ text: p.nama.toUpperCase(), bold: true, size: 32 })]
                                    }),
                                    new Paragraph({
                                        children: [new TextRun({ text: `KELAS: ${p.kelas} | RUANGAN: ${p.ruangan}`, size: 20 })]
                                    }),
                                ],
                            }),
                            new TableCell({
                                width: { size: 20, type: WidthType.PERCENTAGE },
                                children: [
                                    new Paragraph({
                                        alignment: AlignmentType.RIGHT,
                                        children: [
                                            new ImageRun({
                                                data: Uint8Array.from(atob(p.qr.split(",")[1]), c => c.charCodeAt(0)),
                                                transformation: { width: 80, height: 80 }
                                            }),
                                        ],
                                    }),
                                ],
                            }),
                        ],
                    }),
                ],
            }));

            allChildren.push(new Paragraph({ text: "", spacing: { after: 300 } }));

            // --- RENDER SOAL ---
            if (soalTersaring.length === 0) {
                allChildren.push(new Paragraph({
                    alignment: AlignmentType.CENTER,
                    children: [new TextRun({ text: "- Tidak ada soal untuk kelas ini -", italics: true, color: "999999" })]
                }));
            } else {
                for (let idx = 0; idx < soalTersaring.length; idx++) {
                    const s = soalTersaring[idx];
                    
                    allChildren.push(new Paragraph({
                        children: [new TextRun({ text: `SOAL ${idx + 1}`, bold: true, size: 18, color: "666666" })]
                    }));

                    allChildren.push(new Paragraph({
                        spacing: { before: 100, after: 100 },
                        children: [new TextRun({ text: s.teks || "...", size: 24 })]
                    }));

                    if (s.gambar) {
                        try {
                            const imgData = s.gambar.split(",")[1];
                            allChildren.push(new Paragraph({
                                children: [
                                    new ImageRun({
                                        data: Uint8Array.from(atob(imgData), c => c.charCodeAt(0)),
                                        transformation: { 
                                            width: s.lebar, 
                                            height: (s.lebar * 0.75) 
                                        }
                                    }),
                                ],
                            }));
                        } catch (e) { console.error("Gambar error", e); }
                    }

                    allChildren.push(new Paragraph({
                        border: { bottom: { style: BorderStyle.DOTTED, size: 6, color: "CCCCCC" } },
                        spacing: { after: 200 }
                    }));
                }
            }

            // Tambahkan Pemisah Halaman
            if (i < dataPeserta.length - 1) {
                allChildren.push(new Paragraph({ children: [new PageBreak()] }));
            }
        }

        const doc = new Document({
            sections: [{ children: allChildren }]
        });

        Packer.toBlob(doc).then(blob => {
            saveAs(blob, `Soal Ulangan SMAN 12 KAUR{new Date().getTime()}.docx`);
            alert("File Word berhasil diunduh!");
        }).catch(err => {
            console.error(err);
            alert("Terjadi kesalahan teknis saat membuat Word.");
        });
    }
</script>

</body>
</html>
